#!/bin/bash
# ============================================
# Commit-Msg Hook - Conventional Commits
# ============================================
# Enforces conventional commit format
# Part of the AI Agent Workflow system
# ============================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the commit message
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Conventional commit pattern
# Format: type(scope): description
CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: .{3,}"

# Allow merge commits and revert commits
if echo "$COMMIT_MSG" | grep -qE "^Merge|^Revert"; then
    exit 0
fi

# Check if commit message follows conventional format
if ! echo "$COMMIT_MSG" | grep -qE "$CONVENTIONAL_PATTERN"; then
    echo -e "${RED}╔════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  COMMIT REJECTED - Invalid Format         ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}Your commit message:${NC}"
    echo "  $COMMIT_MSG"
    echo ""
    echo -e "${YELLOW}Required format:${NC}"
    echo "  type(scope): description"
    echo ""
    echo "Valid types:"
    echo "  feat:     New feature"
    echo "  fix:      Bug fix"
    echo "  docs:     Documentation changes"
    echo "  style:    Formatting, styling"
    echo "  refactor: Code restructuring"
    echo "  perf:     Performance improvement"
    echo "  test:     Add/update tests"
    echo "  chore:    Maintenance tasks"
    echo ""
    echo "Examples:"
    echo "  feat: add dark mode toggle"
    echo "  fix(tasks): resolve save issue"
    echo "  docs: update README installation"
    echo ""
    echo "See: .github/AI_AGENT_WORKFLOW.md for more examples"
    echo ""
    exit 1
fi

echo -e "${GREEN}✅ Conventional commit format verified${NC}"
exit 0
